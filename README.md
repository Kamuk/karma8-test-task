# karma8-test-task

## Условие задачи
PHP Developer. Test Cases

Вы разрабатываете сервис для рассылки уведомлений об истекающих подписках.
Примерно за три дня до истечения срока подписки, нужно отправить письмо пользователю с текстом "{username}, your subscription is expiring soon".

Имеем следующее:
1. Таблица users в DB с пользователями (1 000 000 строк):
   username — имя
   email — емейл
   validts — unix ts до которого действует ежемесячная подписка 
2. confirmed — 0 или 1 в зависимости от того, подтвердил ли пользователь свой емейл по ссылке (пользователю после регистрации приходит письмо с уникальный ссылкой на указанный емейл, если он нажал на ссылку в емейле в этом поле устанавливается 1)
3. Таблица emails в DB с данными проверки емейл на валидность:
   email — емейл
   checked — 0 или 1 (был ли проверен) valid — 0 или 1 (является ли валидным)
4. Функция check_email( $email )
   Проверяет емейл на валидность и возвращает 0 или 1. Функция работает от 1 секунды до 1 минуты. Вызов функции платный.

5. Функция send_email( $email, $from, $to, $subj, $body ) Отсылает емейл. Функция работает от 1 секунды до 10 секунд.

###Ограничения
1. Необходимо регулярно отправлять емейлы об истечении срока подписки, но только на те емейлы, на которые письмо точно дойдёт. 
2. Можно использовать cron. 
3. Можно создать необходимые таблицыв DB или изменить существующие. 
4. Можно использовать вызов http://localhost/script.php для вызова
   своих скриптов.
5. Для функций check_email и send_email нужно написать "заглушки".
6. Не нужно использовать ООП.
7. Можно задавать вопросы и уточнять условия задачи.
8. Код разместить в GitHub.

## Установка
0. Скопировать файл .env из .env.dist
1. Устанавливаем, если по какой-то причине не установлен docker и docker-compose
2. Запускаем docker-compose build 
3. Затем docker-compose up -d

## Что можно поделать со скриптами
1. Запускаем скрипт http://localhost/generateFakeData.php - он инициализирует БД и заполнит таблицу users данными
2. Запускаем скрипт http://localhost/generateCheckTasks.php - создаст задачи для проверки валидности почты
3. Запускаем скрипт http://localhost/generateSendTasks.php - создаст задачи на отправку писем с оповещением об истечении срока подписки
4. Запускаем скрипт http://localhost/workerForCheckTasks.php - возьмет порцию задач на проверку email и выполнит ее
5. Запускаем скрипт http://localhost/workerForSendTasks.php - возьмет порцию задач на отпавку email и выполнит ее

Или вместо этого можно просто дергать script.php поставив там меньшие временые лимиты

## ToDo на что не хватило времени при реализации тестового сервиса и что может его улучшить
1. Можно поставить cron и повесить на него запуск скриптов, сейчас в качестве имитации можно запускать script.php
2. Можно подключить брокер сообщений вместо использования самописной очереди таблицы tasks
3. Можно написать Makefile чтобы все запскать одной командой для удобства и лаконичности